<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ú©Ø¯ÙˆØ¨Ù„Ùˆ â€” Ø¨Ø§Ø²ÛŒ Ú†Ø§Ù„Ø´â€ŒÚ¯Ùˆ</title>
<style>
  body{font-family:system-ui,-apple-system;direction:rtl;padding:18px;background:#f7f7fb;color:#111}
  h1{font-size:20px;margin:0 0 8px}
  .card{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(12,20,60,0.06);margin-bottom:12px}
  input,button,textarea,select{font-size:16px;padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;box-sizing:border-box;margin-top:6px}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  .small{font-size:13px;color:#555}
  ul{padding-left:18px}
  .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .btn{cursor:pointer;border:none;padding:10px 12px;border-radius:8px;background:#0b84ff;color:#fff}
  .btn.secondary{background:#e6e9f2;color:#123}
  .center{text-align:center}
  .players-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .pill{background:#eef5ff;padding:6px 10px;border-radius:999px}
  .scoreboard{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .score{background:#fff8e6;padding:8px;border-radius:8px}
  footer{font-size:12px;color:#666;margin-top:18px;text-align:center}
</style>
</head>
<body>
<h1>Ú©Ø¯ÙˆØ¨Ù„Ùˆ â€” Ø¨Ø§Ø²ÛŒ Ú†Ø§Ù„Ø´â€ŒÚ¯Ùˆ</h1>

<div class="card">
  <div class="small">Û±) Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†)</div>
  <input id="playersInput" placeholder="Ù…Ø«Ø§Ù„: Ø¹Ù„ÛŒ, Ø³Ø§Ø±Ø§, Ù…Ù‡Ø¯ÛŒ" />
  <div class="controls">
    <button id="setPlayers" class="btn">Ø«Ø¨Øª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†</button>
    <button id="clearPlayers" class="btn secondary">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
  </div>
  <div id="playersArea" class="players-list"></div>
</div>

<div class="card">
  <div class="small">Û²) ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§Ù†Ø¯</div>
  <div class="row">
    <input id="roundsInput" type="number" min="1" value="3" />
    <select id="voiceSelect"></select>
  </div>
  <div class="small">ØµØ¯Ø§: Ø§Ú¯Ø± ØµØ¯Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ ÛŒØ§ Ù…Ù†Ø§Ø³Ø¨ Ù†Ø¯ÛŒØ¯ÛŒØŒ Ø§Ø² Voice Ø³ÛŒØ³ØªÙ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† (ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¢ÛŒÙÙˆÙ† â†’ Siri & Voice â†’ ØµØ¯Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ).</div>
</div>

<div class="card">
  <div class="small">Û³) Ú†Ø§Ù„Ø´â€ŒÙ‡Ø§ Ùˆ ØªÙ†Ø¨ÛŒÙ‡Ø§Øª (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒ)</div>
  <textarea id="chList" rows="4"></textarea>
  <small>Ù‡Ø± Ú†Ø§Ù„Ø´ ÛŒÚ© Ø®Ø· â€” Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ù‚Ø¨Ù„ Ù¾Ø± Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.</small>
  <div style="height:8px"></div>
  <textarea id="pList" rows="3"></textarea>
  <small>Ù‡Ø± ØªÙ†Ø¨ÛŒÙ‡ ÛŒÚ© Ø®Ø·</small>
  <div class="controls">
    <button id="saveLists" class="btn">Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§</button>
    <button id="resetLists" class="btn secondary">Ø¨Ø±Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶</button>
  </div>
</div>

<div class="card center" id="gameCard" style="display:none">
  <div class="small">Û´) Ø¨Ø§Ø²ÛŒ</div>
  <div id="status" style="margin:8px 0">Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø±ÙˆØ¹</div>
  <div class="controls">
    <button id="startBtn" class="btn">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
    <button id="nextBtn" class="btn secondary" style="display:none">Ú†Ø§Ù„Ø´ Ø¨Ø¹Ø¯ÛŒ</button>
    <button id="endBtn" class="btn secondary" style="display:none">Ù¾Ø§ÛŒØ§Ù† Ø²ÙˆØ¯Ù‡Ù†Ú¯Ø§Ù…</button>
  </div>

  <div style="margin-top:12px">
    <div id="currentText" style="min-height:54px;font-weight:600"></div>
    <div style="margin-top:8px" class="controls">
      <button id="didBtn" class="btn secondary" style="display:none">Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ âœ…</button>
      <button id="failBtn" class="btn secondary" style="display:none">Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯ âŒ</button>
      <button id="speakBtn" class="btn" style="display:none">Ø¨Ø§Øª Ø­Ø±Ù Ø¨Ø²Ù†Ù‡ ğŸ”Š</button>
    </div>
  </div>

  <div id="scores" class="scoreboard"></div>
</div>

<footer>ØªØ°Ú©Ø±: Ø§Ø² ØªÙ†Ø¨ÛŒÙ‡Ø§Øª Ø®Ø·Ø±Ù†Ø§Ú© ÛŒØ§ Ø¨Ø¯ÙˆÙ† Ø±Ø¶Ø§ÛŒØª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†ÛŒØ¯.</footer>

<script>
/* ==== Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ==== */
const DEFAULT_CHALLENGES = [
  "Û²Û° Ø«Ø§Ù†ÛŒÙ‡ Ø¢ÙˆØ§Ø² Ø¨Ø®ÙˆÙ†",
  "Û±Ûµ Ø­Ø±Ú©Øª Ø§Ø³Ú©Ø§Øª ÛŒØ§ Ø¯Ø±Ø¬Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡",
  "ÛŒÚ© Ø¬Ù…Ù„Ù‡ Ø·Ù†Ø² Ø¯Ø±Ø¨Ø§Ø±Ù‡â€ŒÛŒ Ø®ÙˆØ¯Øª Ø¨Ú¯Ùˆ",
  "ÛŒÚ© Ø­Ù‚ÛŒÙ‚Øª Ø¬Ø§Ù„Ø¨ Ø¨Ú¯Ùˆ",
  "ÛŒÚ© Ø®Ø§Ø·Ø±Ù‡ Ú©ÙˆØªØ§Ù‡ Ø¨Ú¯Ùˆ",
  "Ø­Ø¯Ø³ Ø¨Ø²Ù† Ù…Ù† Ú†Ù‡ Ø¹Ø¯Ø¯ÛŒ ÙÚ©Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù… (1-10)"
];
const DEFAULT_PUNISHMENTS = [
  "ÛŒÚ© Ø´Ø¹Ø± Ú©ÙˆØªØ§Ù‡ Ø¨Ø®ÙˆÙ†",
  "ÛŒÚ© Ù¾ÛŒØ§Ù… ØªØ´Ú©Ø± Ø¨Ù‡ Ø¯ÙˆØ³ØªÛŒ Ø¨ÙØ±Ø³Øª",
  "ÛŒÚ© Ø´Ú©Ù„Ú© Ø¨Ø§Ù…Ø²Ù‡ Ø¨ÙØ±Ø³Øª",
  "ÛŒÚ© Ø­Ù‚ÛŒÙ‚Øª Ù…Ø«Ø¨Øª Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ø®ÙˆØ¯Øª Ø¨Ú¯Ùˆ",
  "ÛŒÚ© Ø¹Ú©Ø³ Ø®Ù†Ø¯Ù‡â€ŒØ¯Ø§Ø± Ø¨ÙØ±Ø³Øª"
];

let players = [];
let rounds = 3;
let curRound = 0;
let turnIndex = 0;
let scores = {};
let challenges = [];
let punishments = [];
let voice = null;

/* ==== Helpers ==== */
function speak(text){
  if(!('speechSynthesis' in window)){
    alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² speechSynthesis Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
    return;
  }
  // Ù„Ø§Ø²Ù… Ø§Ø³Øª ØµØ¯Ø§ Ø¨Ø§ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¢ØºØ§Ø² Ø´ÙˆØ¯ â€” Ù…Ø§ Ú©Ù„ÛŒØ¯ "Ø¨Ø§Øª Ø­Ø±Ù Ø¨Ø²Ù†Ù‡" Ø±Ø§ Ø¯Ø§Ø±ÛŒÙ…
  const ut = new SpeechSynthesisUtterance(text);
  if(voice) ut.voice = voice;
  ut.lang = 'fa-IR';
  speechSynthesis.cancel();
  speechSynthesis.speak(ut);
}
function rand(a){ return a[Math.floor(Math.random()*a.length)]; }
function renderPlayers(){
  const area = document.getElementById('playersArea');
  area.innerHTML = '';
  for(const p of players){
    const d = document.createElement('div');
    d.className = 'pill';
    d.textContent = p;
    area.appendChild(d);
  }
  // show game card if players exist
  document.getElementById('gameCard').style.display = players.length ? 'block' : 'none';
}
function renderLists(){
  document.getElementById('chList').value = challenges.join('\\n');
  document.getElementById('pList').value = punishments.join('\\n');
}
function renderScores(){
  const box = document.getElementById('scores');
  box.innerHTML = '';
  for(const p of players){
    const el = document.createElement('div');
    el.className = 'score';
    el.innerHTML = `<div style="font-weight:700">${p}</div><div class="small">Ø§Ù…ØªÛŒØ§Ø²: ${scores[p]||0}</div>`;
    box.appendChild(el);
  }
}

/* ==== UI events ==== */
document.getElementById('setPlayers').onclick = ()=>{
  const raw = document.getElementById('playersInput').value;
  players = raw.split(',').map(s=>s.trim()).filter(Boolean);
  players = Array.from(new Set(players)); // ÛŒÚ©ØªØ§
  players = players.slice(0,10); // Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø§Ø®ØªÛŒØ§Ø±ÛŒ
  if(players.length===0){ alert('Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¨Ø§Ø²ÛŒÚ©Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  rounds = parseInt(document.getElementById('roundsInput').value)||3;
  scores = {};
  for(const p of players) scores[p]=0;
  curRound = 0; turnIndex = 0;
  renderPlayers();
  renderScores();
  document.getElementById('status').textContent = 'Ø¢Ù…Ø§Ø¯Ù‡Ù” Ø´Ø±ÙˆØ¹';
};

document.getElementById('clearPlayers').onclick = ()=>{
  document.getElementById('playersInput').value='';
  players=[]; renderPlayers(); scores={}; renderScores();
};

document.getElementById('saveLists').onclick = ()=>{
  challenges = document.getElementById('chList').value.split('\\n').map(s=>s.trim()).filter(Boolean);
  punishments = document.getElementById('pList').value.split('\\n').map(s=>s.trim()).filter(Boolean);
  if(challenges.length===0) challenges = DEFAULT_CHALLENGES.slice();
  if(punishments.length===0) punishments = DEFAULT_PUNISHMENTS.slice();
  localSave();
  alert('Ù„ÛŒØ³Øªâ€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
};

document.getElementById('resetLists').onclick = ()=>{
  challenges = DEFAULT_CHALLENGES.slice();
  punishments = DEFAULT_PUNISHMENTS.slice();
  renderLists();
  localSave();
  alert('Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.');
};

document.getElementById('startBtn').onclick = ()=>{
  if(players.length===0){ alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§Ø²ÛŒÚ©Ù† ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  curRound = 1; turnIndex = 0;
  document.getElementById('startBtn').style.display='none';
  document.getElementById('nextBtn').style.display='inline-block';
  document.getElementById('endBtn').style.display='inline-block';
  nextTurn();
};

document.getElementById('nextBtn').onclick = nextTurn;
document.getElementById('endBtn').onclick = endGame;
document.getElementById('didBtn').onclick = ()=>{
  const p = players[turnIndex];
  scores[p] = (scores[p]||0) + 1;
  renderScores();
  document.getElementById('currentText').textContent = `${p} Ø§Ù…ØªÛŒØ§Ø² Ú¯Ø±ÙØª!`;
  // Ø¨Ø¹Ø¯ Ø§Ø² Ø«Ø¨Øª Ù†ØªÛŒØ¬Ù‡ØŒ Ø¢Ù…Ø§Ø¯Ù‡ Ú†Ø§Ù„Ø´ Ø¨Ø¹Ø¯ÛŒ
};
document.getElementById('failBtn').onclick = ()=>{
  document.getElementById('currentText').textContent = `${players[turnIndex]} Ø§ÛŒÙ† Ú†Ø§Ù„Ø´ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ø§Ø¯.`;
};
document.getElementById('speakBtn').onclick = ()=>{
  speak(document.getElementById('currentText').textContent || 'Ù‡ÛŒÚ† Ù…ØªÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ú¯ÙØªÙ† Ù†ÛŒØ³Øª');
};

/* ==== Ù…Ù†Ø·Ù‚ Ø¨Ø§Ø²ÛŒ ==== */
function nextTurn(){
  // Ø¨Ø³ØªÙ† ØµØ­Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
  speechSynthesis.cancel();

  if(curRound > rounds){ endGame(); return; }
  const p = players[turnIndex];
  const chal = rand(challenges);
  document.getElementById('currentText').textContent = `Ø±Ø§Ù†Ø¯ ${curRound} â€” Ù†ÙˆØ¨Øª ${p}: ${chal}`;
  document.getElementById('status').textContent = `Ø±Ø§Ù†Ø¯ ${curRound} Ø§Ø² ${rounds}`;
  document.getElementById('didBtn').style.display='inline-block';
  document.getElementById('failBtn').style.display='inline-block';
  document.getElementById('speakBtn').style.display='inline-block';
  // Ù‡Ø± Ø¨Ø§Ø± Ú©Ù‡ Ø¨Ù‡ next Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ…ØŒ Ù†ÙˆØ¨Øª Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†
  turnIndex++;
  if(turnIndex >= players.length){
    turnIndex = 0;
    curRound++;
  }
}

function endGame(){
  // ØªØ¹ÛŒÛŒÙ† Ø¨Ø§Ø²Ù†Ø¯Ù‡: Ú©Ù…ØªØ±ÛŒÙ† Ø§Ù…ØªÛŒØ§Ø²
  const min = Math.min(...Object.values(scores));
  const losers = Object.keys(scores).filter(k=>scores[k]===min);
  const punish = rand(punishments);
  let resultText = '';
  if(losers.length===1){
    resultText = `Ø¨Ø§Ø²Ù†Ø¯Ù‡: ${losers[0]}. ØªÙ†Ø¨ÛŒÙ‡: ${punish}`;
  } else {
    resultText = `ØªØ³Ø§ÙˆÛŒ Ø¨ÛŒÙ†: ${losers.join(' Ùˆ ')}. ØªÙ†Ø¨ÛŒÙ‡ Ù…Ø´ØªØ±Ú©: ${punish}`;
  }
  document.getElementById('currentText').textContent = resultText;
  document.getElementById('status').textContent = 'Ø¨Ø§Ø²ÛŒ ØªÙ…Ø§Ù… Ø´Ø¯';
  document.getElementById('nextBtn').style.display='none';
  document.getElementById('endBtn').style.display='none';
  document.getElementById('startBtn').style.display='inline-block';
  document.getElementById('didBtn').style.display='none';
  document.getElementById('failBtn').style.display='none';
  document.getElementById('speakBtn').style.display='inline-block';
  speak(resultText);
  localSave();
}

/* ==== localStorage ==== */
function localSave(){
  localStorage.setItem('kb_ch', JSON.stringify(challenges));
  localStorage.setItem('kb_p', JSON.stringify(punishments));
  localStorage.setItem('kb_players', JSON.stringify(players));
  localStorage.setItem('kb_scores', JSON.stringify(scores));
  localStorage.setItem('kb_rounds', rounds);
}
function localLoad(){
  try{
    const ch = JSON.parse(localStorage.getItem('kb_ch')||'null');
    const p = JSON.parse(localStorage.getItem('kb_p')||'null');
    const pl = JSON.parse(localStorage.getItem('kb_players')||'null');
    const sc = JSON.parse(localStorage.getItem('kb_scores')||'null');
    const rd = parseInt(localStorage.getItem('kb_rounds')||'3');
    challenges = (ch && ch.length)? ch : DEFAULT_CHALLENGES.slice();
    punishments = (p && p.length)? p : DEFAULT_PUNISHMENTS.slice();
    players = (pl && pl.length)? pl : [];
    scores = sc || {};
    rounds = rd || 3;
  }catch(e){
    challenges = DEFAULT_CHALLENGES.slice();
    punishments = DEFAULT_PUNISHMENTS.slice();
    players = [];
    scores = {};
    rounds = 3;
  }
}
localLoad();
renderLists();
renderPlayers();
renderScores();

/* ==== voice list ==== */
function populateVoices(){
  const sel = document.getElementById('voiceSelect');
  sel.innerHTML = '<option value="">(Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø³ÛŒØ³ØªÙ…)</option>';
  const vlist = speechSynthesis.getVoices();
  vlist.forEach((v,i)=>{
    const o = document.createElement('option');
    o.value = i;
    o.textContent = `${v.name} â€” ${v.lang}`;
    sel.appendChild(o);
  });
  sel.onchange = ()=>{
    const idx = sel.value;
    if(idx===''){ voice = null; return; }
    const vlist = speechSynthesis.getVoices();
    voice = vlist[parseInt(idx)] || null;
  };
}
if('speechSynthesis' in window){
  populateVoices();
  speechSynthesis.onvoiceschanged = populateVoices;
}
</script>
</body>
</html>